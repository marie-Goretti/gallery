{% extends 'gallery/base.html' %}
{% load static %}

{% block title %}Publier une image - Gallery{% endblock %}

{% block content %}
<div class="row justify-content-center mt-5">
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-body p-4">
                <h2 class="text-center mb-4">
                    <i class="bi bi-cloud-upload" style="color: #E45B11;"></i>
                    Publier une image
                </h2>
                
                <form method="POST" enctype="multipart/form-data" id="uploadForm">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="{{ form.title.id_for_label }}" class="form-label">Titre</label>
                        <input type="text" name="title" id="{{ form.title.id_for_label }}" class="form-control" placeholder="Titre de votre image" required>
                        {% if form.title.errors %}
                            <div class="text-danger small">{{ form.title.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                        <textarea name="description" id="{{ form.description.id_for_label }}" class="form-control" rows="4" placeholder="Description (optionnel)"></textarea>
                        {% if form.description.errors %}
                            <div class="text-danger small">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- Champ Catégorie -->
                    <div class="mb-3">
                        <label for="category-select" class="form-label">Catégorie</label>
                        <select name="category" id="category-select" class="form-select" required>
                            <option value="">-- Choisir une catégorie --</option>
                            {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Choisissez une catégorie pour filtrer les tags.</div>
                    </div>


                    <!-- Champ Tags -->
                    <div class="mb-3">
                        <label for="tags-input" class="form-label">Tags</label>
                        <div class="position-relative">
                            <input type="text" id="tags-input" class="form-control" placeholder="Tapez pour rechercher des tags..." autocomplete="off">
                            <input type="hidden" name="tags_ids" id="tags-ids">
                            
                            <!-- Liste déroulante des tags -->
                            <ul id="tags-dropdown" class="list-group position-absolute w-100" style="display: none; max-height: 250px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></ul>
                        </div>
                        
                        <!-- Tags sélectionnés -->
                        <div id="selected-tags" class="mt-2"></div>
                        
                        <div class="form-text">Commencez à taper pour voir les suggestions de tags</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.image.id_for_label }}" class="form-label">Image</label>
                        <input type="file" name="image" id="{{ form.image.id_for_label }}" class="form-control" accept="image/*" required>
                        <div class="form-text">Formats acceptés : JPG, PNG, GIF, WEBP (max 5 MB)</div>
                        {% if form.image.errors %}
                            <div class="text-danger small">{{ form.image.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <!-- Prévisualisation de l'image -->
                    <div class="mb-3" id="imagePreviewContainer" style="display: none;">
                        <div class="text-center">
                            <img id="imagePreview" src="" alt="Prévisualisation" class="img-fluid rounded shadow-sm" style="max-height: 300px;">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100" style="background-color: #E45B11; border-color: #E45B11;">
                        <i class="bi bi-upload"></i> Publier l'image
                    </button>
                </form>
                
                <hr class="my-4">
                
                <p class="text-center mb-0">
                    <a href="{% url 'index' %}" style="color: #E45B11;">
                        <i class="bi bi-arrow-left"></i> Retour à la galerie
                    </a>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Variables globales
    let selectedTags = [];
    let searchTimeout;
    
    const tagsInput = document.getElementById('tags-input');
    const tagsDropdown = document.getElementById('tags-dropdown');
    const selectedTagsContainer = document.getElementById('selected-tags');
    const tagsIdsInput = document.getElementById('tags-ids');

    const categorySelect = document.getElementById('category-select');

    categorySelect.addEventListener('change', function() {
        selectedTags = [];
        updateSelectedTagsDisplay();

        const search = tagsInput.value.trim();
        searchTags(search); // recharge immédiatement la liste
    });

    
    // Charger les tags populaires au focus
    tagsInput.addEventListener('focus', function() {
        const search = this.value.trim();
        searchTags(search);
    });
    
    // Recherche dans les tags en temps réel
    tagsInput.addEventListener('input', function() {
        const search = this.value.trim();
        
        clearTimeout(searchTimeout);
        
        // Recherche immédiate même avec 0 caractères
        searchTimeout = setTimeout(() => {
            searchTags(search);
        }, 200);
    });
    
    function searchTags(search) {
        const categoryId = document.getElementById('category-select').value;
        let url = `{% url 'get_tags_by_category' %}`;

        const params = [];

        if (categoryId) params.push(`category=${categoryId}`);
        if (search) params.push(`search=${encodeURIComponent(search)}`);

        if (params.length > 0) url += "?" + params.join("&");

        fetch(url)
            .then(response => response.json())
            .then(data => {
                showDropdown(data.tags, search);
            })
            .catch(error => {
                console.error('Erreur lors du chargement des tags:', error);
            });
    }

    document.getElementById('category-select').addEventListener('change', function() {
        selectedTags = [];
        updateSelectedTagsDisplay();
        tagsInput.value = '';
    });



    
    // Fermer la liste déroulante quand on clique ailleurs
    document.addEventListener('click', function(e) {
        if (!tagsInput.contains(e.target) && !tagsDropdown.contains(e.target)) {
            tagsDropdown.style.display = 'none';
        }
    });
    
    // Navigation au clavier dans la liste
    let selectedIndex = -1;
    
    tagsInput.addEventListener('keydown', function(e) {
        const items = tagsDropdown.querySelectorAll('.list-group-item-action');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
            updateSelection(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, -1);
            updateSelection(items);
        } else if (e.key === 'Enter' && selectedIndex >= 0) {
            e.preventDefault();
            items[selectedIndex].click();
        } else if (e.key === 'Escape') {
            tagsDropdown.style.display = 'none';
            selectedIndex = -1;
        }
    });
    
    function updateSelection(items) {
        items.forEach((item, index) => {
            if (index === selectedIndex) {
                item.classList.add('active');
                item.style.backgroundColor = '#E45B11';
                item.style.color = 'white';
                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.classList.remove('active');
                item.style.backgroundColor = '';
                item.style.color = '';
            }
        });
    }
    
    // Afficher la liste déroulante
    function showDropdown(tags, search) {
        tagsDropdown.innerHTML = '';
        selectedIndex = -1;
        
        const filteredTags = tags.filter(tag => !selectedTags.some(st => st.id === tag.id));
        
        if (filteredTags.length === 0) {
            const message = search 
                ? `<i class="bi bi-search me-2"></i>Aucun tag trouvé pour "${search}"`
                : '<i class="bi bi-info-circle me-2"></i>Commencez à taper pour rechercher des tags';
            tagsDropdown.innerHTML = `<li class="list-group-item text-muted">${message}</li>`;
            tagsDropdown.style.display = 'block';
            return;
        }
        
        filteredTags.forEach((tag, index) => {
            const li = document.createElement('li');
            li.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
            li.style.cursor = 'pointer';
            
            // Style au survol
            li.addEventListener('mouseenter', function() {
                this.style.backgroundColor = '#E45B11';
                this.style.color = 'white';
            });
            
            li.addEventListener('mouseleave', function() {
                if (!this.classList.contains('active')) {
                    this.style.backgroundColor = '';
                    this.style.color = '';
                }
            });
            
            li.textContent = tag.name;
            
            li.addEventListener('click', function() {
                addTag(tag);
                tagsInput.value = '';
                tagsDropdown.style.display = 'none';
                tagsInput.focus();
            });
            
            // Survol avec la souris
            li.addEventListener('mouseenter', function() {
                selectedIndex = index;
                updateSelection(tagsDropdown.querySelectorAll('.list-group-item-action'));
            });
            
            tagsDropdown.appendChild(li);
        });
        
        tagsDropdown.style.display = 'block';
    }
    
    // Ajouter un tag
    function addTag(tag) {
        if (selectedTags.some(st => st.id === tag.id)) {
            return;
        }
        
        selectedTags.push(tag);
        updateSelectedTagsDisplay();
    }
    
    // Supprimer un tag
    function removeTag(tagId) {
        selectedTags = selectedTags.filter(tag => tag.id !== tagId);
        updateSelectedTagsDisplay();
    }
    
    // Mettre à jour l'affichage des tags sélectionnés
    function updateSelectedTagsDisplay() {
        selectedTagsContainer.innerHTML = '';
        
        if (selectedTags.length === 0) {
            tagsIdsInput.value = '';
            return;
        }
        
        selectedTags.forEach(tag => {
            const badge = document.createElement('span');
            badge.className = 'badge me-2 mb-2 d-inline-flex align-items-center';
            badge.style.backgroundColor = '#E45B11';
            badge.style.fontSize = '0.9rem';
            badge.style.padding = '0.5rem 0.75rem';
            
            const tagText = document.createElement('span');
            tagText.textContent = tag.name;
            
            const closeBtn = document.createElement('span');
            closeBtn.className = 'ms-2';
            closeBtn.style.cursor = 'pointer';
            closeBtn.innerHTML = '<i class="bi bi-x-lg"></i>';
            closeBtn.onclick = function() {
                removeTag(tag.id);
            };
            
            badge.appendChild(tagText);
            badge.appendChild(closeBtn);
            selectedTagsContainer.appendChild(badge);
        });
        
        // Mettre à jour l'input caché avec les IDs
        tagsIdsInput.value = selectedTags.map(tag => tag.id).join(',');
    }
    
    // Rendre removeTag accessible globalement
    window.removeTag = removeTag;
    
    // Prévisualisation de l'image lors de la sélection
    document.getElementById('{{ form.image.id_for_label }}').addEventListener('change', function(e) {
        const file = e.target.files[0];
        
        if (file) {
            // Vérifier la taille du fichier (5 MB max)
            const maxSize = 5 * 1024 * 1024;
            if (file.size > maxSize) {
                alert('Le fichier est trop lourd. La taille maximale est de 5 MB.');
                e.target.value = '';
                document.getElementById('imagePreviewContainer').style.display = 'none';
                return;
            }
            
            // Vérifier le type de fichier
            const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                alert('Format de fichier non supporté. Utilisez JPG, PNG, GIF ou WEBP.');
                e.target.value = '';
                document.getElementById('imagePreviewContainer').style.display = 'none';
                return;
            }
            
            // Afficher la prévisualisation
            const reader = new FileReader();
            reader.onload = function(event) {
                document.getElementById('imagePreview').src = event.target.result;
                document.getElementById('imagePreviewContainer').style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            document.getElementById('imagePreviewContainer').style.display = 'none';
        }
    });
</script>
{% endblock %}