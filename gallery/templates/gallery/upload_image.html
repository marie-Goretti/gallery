{% extends 'gallery/base.html' %}
{% load static %}

{% block title %}Publier une image - Gallery{% endblock %}

{% block content %}
<div class="row justify-content-center mt-5">
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-body p-4">
                <h2 class="text-center mb-4">
                    <i class="bi bi-cloud-upload" style="color: #E45B11;"></i>
                    Publier une image
                </h2>
                
                <form method="POST" enctype="multipart/form-data" id="uploadForm">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="{{ form.title.id_for_label }}" class="form-label">Titre</label>
                        <input type="text" name="title" id="{{ form.title.id_for_label }}" class="form-control" placeholder="Titre de votre image" required>
                        {% if form.title.errors %}
                            <div class="text-danger small">{{ form.title.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                        <textarea name="description" id="{{ form.description.id_for_label }}" class="form-control" rows="4" placeholder="Description (optionnel)"></textarea>
                        {% if form.description.errors %}
                            <div class="text-danger small">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.category.id_for_label }}" class="form-label">Catégorie</label>
                        <select name="category" id="{{ form.category.id_for_label }}" class="form-select" required>
                            <option value="">Choisir une catégorie...</option>
                            {% for category in form.fields.category.queryset %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                        {% if form.category.errors %}
                            <div class="text-danger small">{{ form.category.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <!-- Nouveau champ Tags -->
                    <div class="mb-3">
                        <label for="tags-input" class="form-label">Tags</label>
                        <div class="position-relative">
                            <input type="text" id="tags-input" class="form-control" placeholder="Tapez pour rechercher des tags..." autocomplete="off">
                            <input type="hidden" name="tags_ids" id="tags-ids">
                            
                            <!-- Liste déroulante des tags -->
                            <ul id="tags-dropdown" class="list-group position-absolute w-100" style="display: none; max-height: 200px; overflow-y: auto; z-index: 1000;"></ul>
                        </div>
                        
                        <!-- Tags sélectionnés -->
                        <div id="selected-tags" class="mt-2"></div>
                        
                        <div class="form-text">Sélectionnez d'abord une catégorie pour voir les tags disponibles</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.image.id_for_label }}" class="form-label">Image</label>
                        <input type="file" name="image" id="{{ form.image.id_for_label }}" class="form-control" accept="image/*" required>
                        <div class="form-text">Formats acceptés : JPG, PNG, GIF, WEBP (max 5 MB)</div>
                        {% if form.image.errors %}
                            <div class="text-danger small">{{ form.image.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <!-- Prévisualisation de l'image -->
                    <div class="mb-3" id="imagePreviewContainer" style="display: none;">
                        <div class="text-center">
                            <img id="imagePreview" src="" alt="Prévisualisation" class="img-fluid rounded shadow-sm" style="max-height: 300px;">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100" style="background-color: #E45B11; border-color: #E45B11;">
                        <i class="bi bi-upload"></i> Publier l'image
                    </button>
                </form>
                
                <hr class="my-4">
                
                <p class="text-center mb-0">
                    <a href="{% url 'index' %}" style="color: #E45B11;">
                        <i class="bi bi-arrow-left"></i> Retour à la galerie
                    </a>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Variables globales
    let selectedTags = [];
    let availableTags = [];
    
    const categorySelect = document.getElementById('{{ form.category.id_for_label }}');
    const tagsInput = document.getElementById('tags-input');
    const tagsDropdown = document.getElementById('tags-dropdown');
    const selectedTagsContainer = document.getElementById('selected-tags');
    const tagsIdsInput = document.getElementById('tags-ids');
    
    // Désactiver le champ tags si aucune catégorie n'est sélectionnée
    tagsInput.disabled = true;
    
    // Charger les tags quand une catégorie est sélectionnée
    categorySelect.addEventListener('change', function() {
        const categoryId = this.value;
        selectedTags = [];
        updateSelectedTagsDisplay();
        
        if (!categoryId) {
            tagsInput.disabled = true;
            tagsInput.placeholder = 'Sélectionnez d\'abord une catégorie...';
            availableTags = [];
            return;
        }
        
        tagsInput.disabled = false;
        tagsInput.placeholder = 'Tapez pour rechercher des tags...';
        
        // Charger tous les tags de la catégorie
        fetch(`{% url 'get_tags_by_category' %}?category_id=${categoryId}`)
            .then(response => response.json())
            .then(data => {
                availableTags = data.tags;
            })
            .catch(error => {
                console.error('Erreur lors du chargement des tags:', error);
            });
    });
    
    // Afficher/masquer la liste déroulante
    tagsInput.addEventListener('focus', function() {
        if (availableTags.length > 0) {
            showDropdown(availableTags);
        }
    });
    
    // Recherche dans les tags
    tagsInput.addEventListener('input', function() {
        const search = this.value.toLowerCase().trim();
        
        if (!search) {
            showDropdown(availableTags);
            return;
        }
        
        const filtered = availableTags.filter(tag => 
            tag.name.toLowerCase().includes(search) && 
            !selectedTags.some(st => st.id === tag.id)
        );
        
        showDropdown(filtered);
    });
    
    // Fermer la liste déroulante quand on clique ailleurs
    document.addEventListener('click', function(e) {
        if (!tagsInput.contains(e.target) && !tagsDropdown.contains(e.target)) {
            tagsDropdown.style.display = 'none';
        }
    });
    
    // Afficher la liste déroulante
    function showDropdown(tags) {
        tagsDropdown.innerHTML = '';
        
        const filteredTags = tags.filter(tag => !selectedTags.some(st => st.id === tag.id));
        
        if (filteredTags.length === 0) {
            tagsDropdown.style.display = 'none';
            return;
        }
        
        filteredTags.forEach(tag => {
            const li = document.createElement('li');
            li.className = 'list-group-item list-group-item-action';
            li.style.cursor = 'pointer';
            li.textContent = tag.name;
            
            li.addEventListener('click', function() {
                addTag(tag);
                tagsInput.value = '';
                tagsDropdown.style.display = 'none';
            });
            
            tagsDropdown.appendChild(li);
        });
        
        tagsDropdown.style.display = 'block';
    }
    
    // Ajouter un tag
    function addTag(tag) {
        if (selectedTags.some(st => st.id === tag.id)) {
            return;
        }
        
        selectedTags.push(tag);
        updateSelectedTagsDisplay();
    }
    
    // Supprimer un tag
    function removeTag(tagId) {
        selectedTags = selectedTags.filter(tag => tag.id !== tagId);
        updateSelectedTagsDisplay();
    }
    
    // Mettre à jour l'affichage des tags sélectionnés
    function updateSelectedTagsDisplay() {
        selectedTagsContainer.innerHTML = '';
        
        if (selectedTags.length === 0) {
            tagsIdsInput.value = '';
            return;
        }
        
        selectedTags.forEach(tag => {
            const badge = document.createElement('span');
            badge.className = 'badge bg-secondary me-2 mb-2';
            badge.style.fontSize = '0.9rem';
            badge.innerHTML = `
                ${tag.name}
                <i class="bi bi-x-circle ms-1" style="cursor: pointer;" onclick="removeTag(${tag.id})"></i>
            `;
            selectedTagsContainer.appendChild(badge);
        });
        
        // Mettre à jour l'input caché avec les IDs
        tagsIdsInput.value = selectedTags.map(tag => tag.id).join(',');
    }
    
    // Rendre removeTag accessible globalement
    window.removeTag = removeTag;
    
    // Prévisualisation de l'image lors de la sélection
    document.getElementById('{{ form.image.id_for_label }}').addEventListener('change', function(e) {
        const file = e.target.files[0];
        
        if (file) {
            // Vérifier la taille du fichier (5 MB max)
            const maxSize = 5 * 1024 * 1024;
            if (file.size > maxSize) {
                alert('Le fichier est trop lourd. La taille maximale est de 5 MB.');
                e.target.value = '';
                document.getElementById('imagePreviewContainer').style.display = 'none';
                return;
            }
            
            // Vérifier le type de fichier
            const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                alert('Format de fichier non supporté. Utilisez JPG, PNG, GIF ou WEBP.');
                e.target.value = '';
                document.getElementById('imagePreviewContainer').style.display = 'none';
                return;
            }
            
            // Afficher la prévisualisation
            const reader = new FileReader();
            reader.onload = function(event) {
                document.getElementById('imagePreview').src = event.target.result;
                document.getElementById('imagePreviewContainer').style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            document.getElementById('imagePreviewContainer').style.display = 'none';
        }
    });
</script>
{% endblock %}